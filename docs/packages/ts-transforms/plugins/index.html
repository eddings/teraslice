<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Transform Plugins · Teraslice</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;blockquote&gt;
&lt;p&gt;General Plugin Structure, generally the transform/validation operation would be in a seperate file&lt;/p&gt;
&lt;/blockquote&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Transform Plugins · Teraslice"/><meta property="og:type" content="website"/><meta property="og:url" content="https://terascope.github.io/teraslice/"/><meta property="og:description" content="&lt;blockquote&gt;
&lt;p&gt;General Plugin Structure, generally the transform/validation operation would be in a seperate file&lt;/p&gt;
&lt;/blockquote&gt;
"/><meta property="og:image" content="https://terascope.github.io/teraslice/img/docusaurus.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://terascope.github.io/teraslice/img/docusaurus.png"/><link rel="shortcut icon" href="/teraslice/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://terascope.github.io/teraslice/blog/atom.xml" title="Teraslice Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://terascope.github.io/teraslice/blog/feed.xml" title="Teraslice Blog RSS Feed"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/teraslice/js/scrollSpy.js"></script><link rel="stylesheet" href="/teraslice/css/main.css"/><script src="/teraslice/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/teraslice/"><img class="logo" src="/teraslice/img/logo.png" alt="Teraslice"/><h2 class="headerTitleWithLogo">Teraslice</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/teraslice/docs/overview" target="_self">Docs</a></li><li class=""><a href="/teraslice/docs/api" target="_self">API</a></li><li class=""><a href="/teraslice/docs/examples" target="_self">Examples</a></li><li class="siteNavGroupActive"><a href="/teraslice/docs/packages" target="_self">Packages</a></li><li class=""><a href="/teraslice/help" target="_self">Help</a></li><li class=""><a href="/teraslice/blog/" target="_self">Blog</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>ts-transforms</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Overview</h3><ul class=""><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages">Overview</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Packages</h3><ul class=""><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/elasticsearch-store/overview">elasticsearch-store</a></li><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/elasticsearch-api/overview">elasticsearch-api</a></li><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/job-components/overview">job-components</a></li><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/queue/overview">queue</a></li><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/terafoundation/overview">terafoundation</a></li><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/teraslice/overview">teraslice</a></li><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/teraslice-cli/overview">teraslice-cli</a></li><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/teraslice-client-js/overview">teraslice-client-js</a></li><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/teraslice-test-harness/overview">teraslice-test-harness</a></li><div class="navGroup subNavGroup"><h4 class="navGroupSubcategoryTitle">ts-transforms</h4><ul><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/ts-transforms/overview">Overview</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/teraslice/docs/packages/ts-transforms/plugins">Plugins</a></li><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/ts-transforms/operations">Operations</a></li></ul></div><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/utils/overview">utils</a></li><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/xlucene-evaluator/overview">xlucene-evaluator</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Legacy</h3><ul class=""><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/error-parser/overview">error-parser</a></li><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/teraslice-op-test-harness/overview">teraslice-op-test-harness</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Internal</h3><ul class=""><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/chunked-file-reader/overview">chunked-file-reader</a></li><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/data-access/overview">data-access</a></li><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/data-access-plugin/overview">data-access-plugin</a></li><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/docker-compose-js/overview">docker-compose-js</a></li><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/generator-teraslice/overview">generator-teraslice</a></li><li class="navListItem"><a class="navItem" href="/teraslice/docs/packages/teraslice-messaging/overview">teraslice-messaging</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Transform Plugins</h1></header><article><div><span><blockquote>
<p>General Plugin Structure, generally the transform/validation operation would be in a seperate file</p>
</blockquote>
<p>PluginFile.ts</p>
<pre><code class="hljs css language-ts">
<span class="hljs-keyword">import</span> { DataEntity } <span class="hljs-keyword">from</span> <span class="hljs-string">'@terascope/utils'</span>;
<span class="hljs-keyword">import</span> { OperationConfig, TransformOpBase } <span class="hljs-keyword">from</span> <span class="hljs-string">'ts-transforms'</span>;

<span class="hljs-keyword">class</span> Double <span class="hljs-keyword">extends</span> TransformOpBase {
    <span class="hljs-keyword">constructor</span>(<span class="hljs-params">config: OperationConfig</span>) {
        <span class="hljs-keyword">super</span>(config);
    }

    run(doc: DataEntity) {
        doc[<span class="hljs-keyword">this</span>.source] = doc[<span class="hljs-keyword">this</span>.source] * <span class="hljs-number">2</span>;
        <span class="hljs-keyword">return</span> doc;
    }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> Plugin {
    init() {
        <span class="hljs-keyword">return</span> {
            noop: NoOp,
            double: Double
        };
    }
}
</code></pre>
<p><code>NOTE</code>: it is important to know that the key of the object returned from init will be the name that must be used in the rules and the value is the actual class</p>
<p>pluginRules.txt</p>
<pre><code class="hljs css language-json">{ <span class="hljs-attr">"selector"</span>: <span class="hljs-string">"size:2"</span>, <span class="hljs-attr">"source_field"</span>: <span class="hljs-string">"size"</span>, <span class="hljs-attr">"target_field"</span>: <span class="hljs-string">"height"</span>, <span class="hljs-attr">"tag"</span>: <span class="hljs-string">"pluginTag"</span> }
{ <span class="hljs-attr">"follow"</span>: <span class="hljs-string">"pluginTag"</span>, <span class="hljs-attr">"post_process"</span>: <span class="hljs-string">"double"</span> }
</code></pre>
<p>You insert an array of plugin classes at init</p>
<pre><code class="hljs css language-ts">
<span class="hljs-keyword">import</span> Plugins <span class="hljs-keyword">from</span> <span class="hljs-string">'PluginFile'</span>;
<span class="hljs-keyword">import</span> { Transform } <span class="hljs-keyword">from</span> <span class="hljs-string">'ts-transforms'</span>

<span class="hljs-keyword">const</span> config = {
    rules: [<span class="hljs-string">'/path/to/pluginRules.txt'</span>],
    <span class="hljs-keyword">type</span>: <span class="hljs-string">'transform'</span>
};

<span class="hljs-keyword">const</span> data = [{ size: <span class="hljs-number">2</span> }];

<span class="hljs-keyword">const</span> transform = <span class="hljs-keyword">new</span> Transform(config);
<span class="hljs-keyword">await</span> transform.init([Plugins]);

<span class="hljs-keyword">const</span> results = transform.run(data);

<span class="hljs-built_in">console</span>.log(results) <span class="hljs-comment">// [{ height: 4 }]</span>

</code></pre>
<h4><a class="anchor" aria-hidden="true" id="transform-operations"></a><a href="#transform-operations" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Transform Operations</h4>
<p>It is important to inherit from the TransformOpBase class if at all possible as it does some normailization and validation. You can of course do things as you would like. You can also override the validateConfig method if you have another specific way to do so.</p>
<p>The returning class must have a <code>run</code> method which is called by the framework and is given an object (DataEntity, which is just an object with a way to set and manipulate metadata transparently)</p>
<p>Errors must not interupt the pipeline</p>
<p>The configuration <code>source_field</code> and <code>target_field</code> are set to <code>this.source</code> and <code>this.target</code> respectively</p>
<p>Example</p>
<pre><code class="hljs css language-ts"><span class="hljs-keyword">import</span> { DataEntity } <span class="hljs-keyword">from</span> <span class="hljs-string">'@terascope/utils'</span>;
<span class="hljs-keyword">import</span> _ <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>;
<span class="hljs-keyword">import</span> { TransformOpBase, OperationConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'ts-transforms'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> JsonParse <span class="hljs-keyword">extends</span> TransformOpBase {
    <span class="hljs-keyword">constructor</span>(<span class="hljs-params">config: OperationConfig</span>) {
        <span class="hljs-keyword">super</span>(config);
    }

    run(doc: DataEntity): DataEntity {
        <span class="hljs-keyword">const</span> field = _.get(doc, <span class="hljs-keyword">this</span>.source);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> json = <span class="hljs-built_in">JSON</span>.parse(field);
            _.set(doc, <span class="hljs-keyword">this</span>.target, json);
            _.unset(doc, <span class="hljs-keyword">this</span>.source);
        } <span class="hljs-keyword">catch</span> (err) {
            _.unset(doc, <span class="hljs-keyword">this</span>.source);
        }
        <span class="hljs-keyword">return</span> doc;
    }
}

</code></pre>
<h4><a class="anchor" aria-hidden="true" id="validation-operations"></a><a href="#validation-operations" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Validation Operations</h4>
<p>It is important to inherit from the ValidationOpBase class if at all possible as it does some normailization, validation and other important framework behaviour especially in regards to how <code>output:false</code> works.</p>
<p>The returning class must have a <code>run</code> method (which is done through the ValidationOpBase class). If you are using the base class then you need to specify a <code>validate</code> method which takes in the value of the source key and must return a boolen if it is valid. You may also specify a <code>normalize</code> method which will alter the data before it hits the <code>validate</code> method. This will also normalize the output record itself</p>
<p>The configuration <code>source_field</code> and <code>target_field</code> are set to <code>this.source</code> and <code>this.target</code> respectively</p>
<p>Example</p>
<pre><code class="hljs css language-ts"><span class="hljs-keyword">import</span> { DataEntity } <span class="hljs-keyword">from</span> <span class="hljs-string">'@terascope/utils'</span>;
<span class="hljs-keyword">import</span> _ <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>;
<span class="hljs-keyword">import</span> validator <span class="hljs-keyword">from</span> <span class="hljs-string">'validator'</span>;
<span class="hljs-keyword">import</span> { ValidationOpBase, OperationConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'ts-transforms'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> MacAddress <span class="hljs-keyword">extends</span> ValidationOpBase&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">case</span>: <span class="hljs-string">'lowercase'</span> | <span class="hljs-string">'uppercase'</span>;
    <span class="hljs-keyword">private</span> preserveColons: <span class="hljs-built_in">boolean</span>;

    <span class="hljs-keyword">constructor</span>(<span class="hljs-params">config: OperationConfig</span>) {
        <span class="hljs-keyword">super</span>(config);
        <span class="hljs-keyword">this</span>.case = config.case || <span class="hljs-string">'lowercase'</span>;
        <span class="hljs-keyword">this</span>.preserveColons = config.preserve_colons || <span class="hljs-literal">false</span>;
    }

    normalize(data: <span class="hljs-built_in">any</span>, _doc: DataEntity) {
        <span class="hljs-keyword">let</span> results = data;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> data !== <span class="hljs-string">'string'</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'data must be a string'</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.case === <span class="hljs-string">'lowercase'</span>) results = results.toLowerCase();
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.case === <span class="hljs-string">'uppercase'</span>) results = results.toUpperCase();
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.preserveColons) results = results.replace(<span class="hljs-regexp">/:/gi</span>, <span class="hljs-string">''</span>);
        <span class="hljs-keyword">return</span> results;
    }

    validate(data: <span class="hljs-built_in">string</span>) {
        <span class="hljs-keyword">const</span> options = { no_colons: !<span class="hljs-keyword">this</span>.preserveColons };
        <span class="hljs-keyword">if</span> (!validator.isMACAddress(data, options)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}


#### Operation Cardinality
Each operation is designed <span class="hljs-keyword">for</span> a specify task. These operations work either work on a single input, several inputs (like the join operator) and <span class="hljs-keyword">return</span> a single output. To differentiate the operators and to determine at validation time <span class="hljs-keyword">if</span> the operator can take <span class="hljs-keyword">in</span> multiple outputs each <span class="hljs-keyword">class</span> must have a <span class="hljs-keyword">static</span> varialble labeling what it is meant to <span class="hljs-keyword">do</span>. The options are either <span class="hljs-string">`one-to-one`</span> or <span class="hljs-string">`many-to-one`</span>. If by using the tag/follow rules a <span class="hljs-string">`one-to-one`</span> has several inputs then it will be cloned <span class="hljs-keyword">as</span> many times <span class="hljs-keyword">as</span> there are inputs so that each operation will have a single input. A <span class="hljs-string">`many-to-one`</span> will take multiple outputs and <span class="hljs-keyword">set</span> it at <span class="hljs-string">`source_fields`</span> (note that it is the plural form). If you inherit <span class="hljs-keyword">from</span> the base clase then it will <span class="hljs-keyword">default</span> to <span class="hljs-string">`one-to-one`</span>.


<span class="hljs-string">``</span><span class="hljs-string">`js
// the none inherited version of a plugin
export default class Double {
    static cardinality: InputOutputCardinality = 'one-to-one';

    constructor(config) {
        this.config = config;
    }

    run(doc: DataEntity) {
        // @ts-ignore
        doc[this.config.source_field] = doc[this.config.source_field] * 2;
        return doc;
    }
}
</span></code></pre>
<pre><code class="hljs css language-js">
<span class="hljs-keyword">import</span> _ <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MakeArray</span> </span>{

    <span class="hljs-keyword">static</span> cardinality = <span class="hljs-string">'many-to-one'</span>;

    <span class="hljs-keyword">constructor</span>(config:) {
        <span class="hljs-comment">// this will look for the fields config or look for the multi input located at source_fields</span>
        <span class="hljs-keyword">const</span> fields = config.fields || config.source_fields;
        <span class="hljs-keyword">this</span>.fields = fields;
        <span class="hljs-keyword">this</span>.target = config.target_field;
    }


    run(doc) {
        <span class="hljs-keyword">const</span> results = [];
        <span class="hljs-keyword">this</span>.fields.forEach(<span class="hljs-function"><span class="hljs-params">field</span> =&gt;</span> {
            <span class="hljs-keyword">const</span> data = _.get(doc, field);
            <span class="hljs-keyword">if</span> (data) results.push(data);
        });
        <span class="hljs-keyword">if</span> (results.length &gt; <span class="hljs-number">0</span>) _.set(doc, <span class="hljs-keyword">this</span>.target, results);
        <span class="hljs-keyword">return</span> doc;
    }
}


</code></pre>
</span></div></article></div><div class="docLastUpdate"><em>Last updated on 3/14/2019</em></div><div class="docs-prevnext"><a class="docs-prev button" href="/teraslice/docs/packages/ts-transforms/overview"><span class="arrow-prev">← </span><span>Overview</span></a><a class="docs-next button" href="/teraslice/docs/packages/ts-transforms/operations"><span>Operations</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/teraslice/" class="nav-home"></a><div><h5>Docs</h5><a href="/teraslice/docs/en/getting-started.html">Getting Started</a><a href="/teraslice/docs/en/packages.html">Packages</a><a href="/teraslice/docs/en/apis.html">API Reference</a></div><div><h5>More</h5><a href="/teraslice/blog">Blog</a><a href="https://github.com/terascope/teraslice">GitHub</a><a class="github-button" data-icon="octicon-star" data-count-href="/terascope/teraslice/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><section class="copyright">Copyright © 2019 Terascope, LLC</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'b074b9b57bfd2e4d8b411aee052825d2',
                indexName: 'terascope_teraslice',
                inputSelector: '#search_input_react'
              });
            </script></body></html>